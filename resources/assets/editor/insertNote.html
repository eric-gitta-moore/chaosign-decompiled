<!doctype html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1, user-scalable=no" />
<meta charset="utf-8">
<title></title>
<link type="text/css" rel="stylesheet" href="css/style.css"/>
</head>

<body onhashchange="hashChangeFire()">
    <div class="attach-box" id="attach-box"><b class="closeAnnex"></b></div>
    <script type="text/javascript" src="js/jquery.min.js"></script>
    <script type="text/javascript" src="js/attachment_common.js"></script>
    <script type="text/javascript">
    	//判断移动端
    	var u = navigator.userAgent;
		var isAndroid = u.indexOf('Android') > -1 || u.indexOf('Adr') > -1; //android终端
		var isIOS = !!u.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/); //ios终端
		function hashChangeFire(){
            if(getUrlParam('isiframeClose')){
                $(".closeAnnex").show();
            }
        }
        function getUrlParam(name){
            var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)"); //构造一个含有目标参数的正则表达式对象
            var r = window.location.hash.substr(1).match(reg);  //匹配目标参数
            if (r != null) return r[2]; return null; //返回参数值
        }
        //2021.04.22
        var editorClientType = true;
        if(getUrlParam('editorClientType')){
        	if(getUrlParam('editorClientType') == 'false'){
        		editorClientType = false;
        	}
        }
        var jsonOld = window.name;
        try{
            jsonOld = b64DecodeUnicode(jsonOld);
        }catch(e){

        }
        try{
            json = JSON.parse(jsonOld);
        }catch(e){
            json = "";
        }
        if(json == ""){
        }
        var att_note = json.att_note || "";
        if (att_note != "") {
            var att_note_title = att_note.title || "";
            var att_note_contentTxt = att_note.contentTxt || "";
            var att_note_creatorName = att_note.creatorName || "";
            if(att_note_title=="" && att_note_contentTxt==""){
            	if(att_note.images && att_note.images.length>0){
            		att_note_title="图片";
            	}else{
            		att_note_title="笔记";
            	}
            }
            if(att_note.images && att_note.images.length>0){
                var img=att_note.images[0];
                img = img.replace(/.webp/g, '.jpg');
                if (img.indexOf("chaoxing.com") != -1) {
                    img = img.replace(/star3\/(origin|([0-9]+_[0-9]+.*?))\//g, 'star3/100_100cQ50/');
                }
				img = img.replace('cximg://','')
                var html = '<div aria-hidden="false" role="option" class="attach_item insertNote">'+
                                '<div aria-hidden="true" class="img squareRadius"><img src="'+img+'"></div>'+
                                '<div class="attach_infor">'+
                                    '<h2>'+att_note_title+'</h2>'+
                                    '<p class="aside">'+att_note_contentTxt+'</p>'+
                                    '<p class="from">来自-<span class="blue">'+att_note_creatorName+'</span>的笔记</p>'+
                                '</div>'+
                            '</div>';
            }else{
                var html = '<div aria-hidden="false" role="option" class="attach_item insertNote clearfix">'+
                                '<div class="attach_infor">'+
                                    '<h2>'+att_note_title+'</h2>'+
                                    '<p class="aside">'+att_note_contentTxt+'</p>'+
                                    '<p class="from">来自-<span class="blue">'+att_note_creatorName+'</span>的笔记</p>'+
                                '</div>'+
                            '</div>';
            }
            $(".attach-box").append(html);
            if(json.cid){
            	var cid=json.cid;
            	if(!att_note.title && att_note_contentTxt==""){//标题和正文都没有
            		$('.attach_infor h2').css('margin-bottom','4px');
            	}else if(att_note_title!='' && att_note_contentTxt==''){//只有标题
            		$('.attach_infor h2').css('margin-bottom','0')
            		$('.attach_infor h2').addClass('words2');
            	}else if(att_note_title=='' && att_note_contentTxt!=''){//只有正文
            		$('.attach_infor h2').css('margin-bottom','0')
            		$('.attach_infor .aside').css({'font-size':'15px','color':'#333333','line-height':'1.23'}).addClass('words2');
            	}else if(att_note_title!='' && att_note_contentTxt!=''){//标题和正文同时存在
            		$('.attach_infor .aside').addClass('words2');
            		$('.attach_infor h2').css('margin-bottom','3px');
            		$('.attach_infor p.from').css('margin-top','3px');
            		if($('.attach_infor .aside').height()>$('.attach_infor .aside').css('line-height').substr(0,$('.attach_infor .aside').css('line-height').length-2)){
                        $('.attach_item').css('height','90px');

                        if(editorClientType == true){
			                if (isAndroid && (typeof javaJs !== 'undefined')) {
				               javaJs.executeParentJs('changeIframeHeight("'+cid+'",90)');
				            }
	                        if (isIOS) {
	                            if(window.webkit && window.webkit.messageHandlers.executeParentJs){
	                                window.webkit.messageHandlers.executeParentJs.postMessage(['changeIframeHeight("'+cid+'",90)']);
	                            }else{
	                    　　　　     if(window.top["executeParentJs"]) {
	                                    window.top["executeParentJs"]('changeIframeHeight("'+cid+'",90)');
	                                }
	                            }
	                        }
		                }else{
		                	//改变高度2021.05
		                	parent.postMessage({'msgType':'changeIframeHeight','cid': cid,"height":90}, '*');
		                }
            		}
            	}
            }
        }
        if(json.cid){
            var cid=json.cid;
            //显示附件叉号2021.05
            attachmentUtils.showiframeClose(cid,editorClientType);
        }
        // 附件点击调客户端方法
        function openClickEvent(e,attachment){
        	attachmentUtils.openClickEvent(e,attachment,json,editorClientType);
        }
        //长按附件
        var touchY = 0;
        var longClick =0;
        $(".attach-box").on({
            touchstart: function(e){
                longClick=0;
                timeOutEvent = setTimeout(function(){
                    //此处为长按事件
                    longClick=1;//假如长按，则设置为1
                    if(json.cid){
                        var cid=json.cid;
                        if (isAndroid && (typeof javaJs !== 'undefined')) {
                           javaJs.executeParentJs('zss_editor.iframeForward("'+cid+'")');
                        }
                        if (isIOS) {
                            if(window.webkit && window.webkit.messageHandlers.executeParentJs){
                            window.webkit.messageHandlers.executeParentJs.postMessage(['zss_editor.iframeForward("'+cid+'")']);
                            }else{
                    　　　　     if(window.top["executeParentJs"]) {
                                    window.top["executeParentJs"]('zss_editor.iframeForward("'+cid+'")');
                                }
                            }
                        }
                    }

                },500);
                var touch = e.originalEvent.targetTouches[0];
                touchY = touch.clientY;
            },
            touchmove: function(e){
                clearTimeout(timeOutEvent);
                timeOutEvent = 0;
                var touch = e.originalEvent.changedTouches[0];
                if(Math.abs(touch.clientY - touchY) < 10){
                    if(isAndroid){
                     e.preventDefault();
                    }
                }
            },
            touchend: function(e){
                clearTimeout(timeOutEvent);
                if(timeOutEvent!=0 && self.longClick==0){//点击
                   //此处为点击事件----在此处跳转
                   openClickEvent(e,jsonOld)
                }
                return false;
            }
        });
        $('.attach-box').bind('contextmenu', function(e) {
          e.preventDefault();
        })
    </script>
</body>
</html>
